{% extends "base.html" %}
{% block title %}Results: {{ query }} - Adopt-a-Pet{% endblock %}

{% block content %}
<!-- Search bar (persistent) -->
<form action="/search" method="get" class="mb-6">
    <div class="flex gap-2">
        <input
            type="text"
            name="q"
            value="{{ query if response.query_type == 'text' else '' }}"
            placeholder="Search for pets..."
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
        >
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
            Search
        </button>
        <a href="/" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
            Home
        </a>
    </div>
</form>

<!-- Results summary -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h2 class="text-xl font-semibold text-gray-800">
            {% if response.query_type == "text" %}
                Results for "{{ response.query }}"
            {% else %}
                Results for uploaded image
            {% endif %}
        </h2>
        <p class="text-sm text-gray-500">
            {{ response.total_hits }} results in {{ response.search_time_ms }}ms
        </p>
    </div>
</div>

{% if response.results %}
<!-- Results grid -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {% for result in response.results %}
    <div class="bg-white rounded-lg shadow-sm border hover:shadow-md transition overflow-hidden">
        <!-- Pet image -->
        <div class="aspect-square bg-gray-100 relative">
            {% if result.pet.source == "petfinder" %}
                {% set img_filename = result.pet.image_path.split("/")[-1].split("\\")[-1] %}
                <img
                    src="/images/petfinder/{{ img_filename }}"
                    alt="{{ result.pet.name }}"
                    class="w-full h-full object-cover"
                    onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f3f4f6%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No image</text></svg>'"
                >
            {% else %}
                {% set img_filename = result.pet.image_path.split("/")[-1].split("\\")[-1] %}
                <img
                    src="/images/oxford/{{ img_filename }}"
                    alt="{{ result.pet.breed }}"
                    class="w-full h-full object-cover"
                    onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f3f4f6%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%239ca3af%22 font-size=%2212%22>No image</text></svg>'"
                >
            {% endif %}

            <!-- Source badge -->
            <span class="absolute top-2 left-2 px-2 py-0.5 text-xs font-medium rounded
                {% if result.pet.source == 'petfinder' %}
                    bg-blue-100 text-blue-800
                {% else %}
                    bg-purple-100 text-purple-800
                {% endif %}
            ">
                {% if result.pet.source == "petfinder" %}PetFinder{% else %}Oxford-IIIT{% endif %}
            </span>

            <!-- Species badge -->
            <span class="absolute top-2 right-2 px-2 py-0.5 text-xs font-medium rounded
                {% if result.pet.species == 'Dog' %}
                    bg-amber-100 text-amber-800
                {% else %}
                    bg-pink-100 text-pink-800
                {% endif %}
            ">
                {{ result.pet.species }}
            </span>
        </div>

        <!-- Pet info -->
        <div class="p-4">
            <h3 class="font-semibold text-gray-800 truncate">{{ result.pet.name }}</h3>
            <p class="text-sm text-gray-600">{{ result.pet.breed }}</p>

            {% if result.pet.age_months %}
            <p class="text-xs text-gray-500 mt-1">
                {% if result.pet.age_months < 12 %}
                    {{ result.pet.age_months }} months old
                {% else %}
                    {{ result.pet.age_months // 12 }} years old
                {% endif %}
                {% if result.pet.gender %} | {{ result.pet.gender }}{% endif %}
            </p>
            {% endif %}

            <!-- Description (truncated) -->
            <p class="text-xs text-gray-500 mt-2 line-clamp-3">
                {{ result.pet.description[:150] }}{% if result.pet.description|length > 150 %}...{% endif %}
            </p>

            <!-- Score bar -->
            <div class="mt-3">
                <div class="flex items-center justify-between text-xs text-gray-400 mb-1">
                    <span>Match score</span>
                    <span>{{ "%.2f"|format(result.score) }}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5">
                    {% set score_pct = (result.score / (response.results[0].score if response.results else 1) * 100) | int %}
                    <div class="bg-indigo-500 h-1.5 rounded-full" style="width: {{ score_pct }}%"></div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-16">
    <p class="text-gray-500 text-lg">No results found. Try a different search query.</p>
    <a href="/" class="mt-4 inline-block text-indigo-600 hover:underline">Back to home</a>
</div>
{% endif %}
{% endblock %}
